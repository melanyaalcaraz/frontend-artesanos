<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>Inicio - Artesanos.com</title>
  <link rel="stylesheet" href="css.css ">
</head>

<body>


  <h1>Artesanos.com</h1>
  <h2>Bienvenido, <span id="nombreUsuario"></span></h2>
  <button> <a href="amistades.html">Buscar usuario</a></button>
  <button> <a href="solicitudes.html">Ver Solicitudes</a></button>
  <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>

  <hr>

  <h3>üì∏ Publicar una imagen</h3>
  <form id="formImagen">
    <label for="">
      <input type="text" id="titulo" placeholder="T√≠tulo de la imagen" required>
    </label>

    <label for="">
      <input type="file" id="archivoImagen" name="imagen" accept="image/*" placeholder="Imagen" required>
    </label>

    <button type="submit">Subir imagen</button>

    <p id="estadoPublicacion"></p>
  </form>
  <hr>

  <h3>üé® Im√°genes compartidas</h3>
  <div id="galeria">
    <p>No hay im√°genes a√∫n.</p>
  </div>

  <!-- <script>

    const token = localStorage.getItem('token');
    if (!token) {
      alert('Debes iniciar sesi√≥n');
      window.location.href = 'login.html';
    }

    // Obtener info del usuario desde el token
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('nombreUsuario').textContent = payload.nombre;

    function cerrarSesion() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

    document.getElementById('formImagen').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value;
      const archivo = document.getElementById('archivoImagen').files[0];
      const estado = document.getElementById('estadoPublicacion');

      if (!archivo) {
        estado.textContent = 'Seleccion√° una imagen.';
        return;
      }

      const formData = new FormData();
      formData.append('titulo', titulo);
      formData.append('imagen', archivo);

      try {
        const res = await fetch('https://backend-artesanos.onrender.com/api/imagenes', {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + token
          },
          body: formData
        });

        const data = await res.json();
        if (res.ok) {
          estado.style.color = 'green';
          estado.textContent = 'Imagen subida correctamente.';
          document.getElementById('formImagen').reset();
        } else {
          estado.style.color = 'red';
          estado.textContent = data.error || 'Error al subir la imagen.';
        }
      } catch (err) {
        estado.style.color = 'red';
        estado.textContent = 'Error de red.';
      }
    });

    // TODO: cargar solicitudes de amistad y galer√≠a
      const rutasAmistades = require('./routes/amistades');
     app.use('/api/amistad', rutasAmistades);

  </script> -->
  <!-- <script>
    //const API = 'https://backend-artesanos.onrender.com';
    const API = 'http://localhost:3000'; // Cambi√° a Render si sub√≠s online
    const token = localStorage.getItem('token');

    // Validaci√≥n de sesi√≥n
    if (!token) {
      alert('Debes iniciar sesi√≥n');
      window.location.href = 'login.html';
    }

    // Mostrar nombre del usuario desde el token
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('nombreUsuario').textContent = payload.nombre;

    // Cerrar sesi√≥n
    function cerrarSesion() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

    // Subida de imagen
    document.getElementById('formImagen').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value.trim();
      const archivo = document.getElementById('archivoImagen').files[0];
      const estado = document.getElementById('estadoPublicacion');

      if (!titulo || !archivo) {
        estado.textContent = 'Complet√° todos los campos.';
        estado.style.color = 'red';
        return;
      }

      const formData = new FormData();
      formData.append('titulo', titulo);
      formData.append('imagen', archivo);

      try {
        const res = await fetch(`${API}/api/imagenes`, {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + token
          },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          estado.textContent = data.mensaje;
          estado.style.color = 'green';
          document.getElementById('formImagen').reset();
        } else {
          estado.textContent = data.error || 'Error al subir imagen.';
          estado.style.color = 'red';
        }
      } catch (error) {
        estado.textContent = 'Error de red o servidor.';
        estado.style.color = 'red';
      }
   


    async function cargarGaleria() {
      const res = await fetch(`${API}/api/imagenes`, {
        headers: {
          Authorization: 'Bearer ' + token
        }
      });

      const imagenes = await res.json();
      const galeria = document.getElementById('galeria');
      galeria.innerHTML = '';

      if (!imagenes.length) {
        galeria.innerHTML = '<p>No subiste ninguna imagen a√∫n.</p>';
        return;
      }

      imagenes.forEach(img => {
        const div = document.createElement('div');
        div.innerHTML = `
      <p><strong>${img.titulo}</strong></p>
      <img src="${API}/public/imagenes/${img.archivo}" alt="${img.titulo}" width="300" style="border-radius: 8px; margin-bottom: 20px;">
    `;
        galeria.appendChild(div);
      });
    }

    if (res.ok) {
      estado.textContent = data.mensaje;
      estado.style.color = 'green';
      document.getElementById('formImagen').reset();
      cargarGaleria(); // üîÅ recarga galer√≠a despu√©s de subir
    }

    cargarGaleria(); 
  
  });
  </script> -->

<!-- 
  <script>
    const API = 'http://localhost:3000'; // Cambiar por tu dominio en producci√≥n
    const token = localStorage.getItem('token');

    if (!token) {
      alert('Debes iniciar sesi√≥n');
      window.location.href = 'login.html';
    }

    // Mostrar nombre del usuario
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('nombreUsuario').textContent = payload.nombre;

    function cerrarSesion() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

    document.getElementById('formImagen').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value.trim();
      const archivo = document.getElementById('archivoImagen').files[0];
      const estado = document.getElementById('estadoPublicacion');

      if (!titulo || !archivo) {
        estado.textContent = 'Complet√° todos los campos.';
        estado.style.color = 'red';
        return;
      }

      const formData = new FormData();
      formData.append('titulo', titulo);
      formData.append('imagen', archivo);

      try {
        const res = await fetch(`${API}/api/imagenes`, {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + token
          },
          body: formData
        });

        const data = await res.json();

        if (res.ok) {
          estado.textContent = data.mensaje;
          estado.style.color = 'green';
          document.getElementById('formImagen').reset();
          cargarGaleria();
        } else {
          estado.textContent = data.error || 'Error al subir imagen.';
          estado.style.color = 'red';
        }
      } catch (error) {
        estado.textContent = 'Error de red o servidor.';
        estado.style.color = 'red';
        console.error(error);
      }
    });

    // async function cargarGaleria() {
    //   try {
    //     const res = await fetch(`${API}/api/imagenes`, {
    //       headers: {
    //         Authorization: 'Bearer ' + token
    //       }
    //     });

    //     const imagenes = await res.json();
    //     const galeria = document.getElementById('galeria');
    //     galeria.innerHTML = '';

    //     if (!imagenes.length) {
    //       galeria.innerHTML = '<p>No subiste ninguna imagen a√∫n.</p>';
    //       return;
    //     }

    //     imagenes.forEach(img => {
    //       const div = document.createElement('div');
    //       div.className = 'galeria-item';
    //       div.innerHTML = `
    //         <p><strong>${img.titulo}</strong></p>
    //         <img src="${API}/public/imagenes/${encodeURIComponent(img.archivo)}" alt="${img.titulo}">

    //       `;
    //       galeria.appendChild(div);
    //     });
    //   } catch (err) {
    //     console.error('Error al cargar galer√≠a:', err);
    //   }
    async function cargarGaleria() {
  try {
    const res = await fetch(`${API}/api/imagenes`, {
      headers: {
        Authorization: 'Bearer ' + token
      }
    });

    const imagenes = await res.json();
    const galeria = document.getElementById('galeria');
    galeria.innerHTML = '';

    if (!imagenes.length) {
      galeria.innerHTML = '<p>No subiste ninguna imagen a√∫n.</p>';
      return;
    }

    imagenes.forEach(img => {
      const div = document.createElement('div');
      div.className = 'galeria-item';
      const ruta = `${API}/public/imagenes/${encodeURIComponent(img.archivo)}`;
      div.innerHTML = `
        <p><strong>${img.titulo}</strong></p>
        <img src="${ruta}" alt="${img.titulo}" style="max-width:100%; border-radius:10px;">
      `;
      galeria.appendChild(div);
    });
  } catch (err) {
    console.error('Error al cargar galer√≠a:', err);
  }
}

    // }

    // Cargar al iniciar
    cargarGaleria();
  </script> -->

  <script>
    // üåê Direcci√≥n del backend
    const API = 'http://localhost:3000';
    // const API = 'https://backend-artesanos.onrender.com'; // Us√° esto si est√°s en producci√≥n
  
    // üîê Obtener token
    const token = localStorage.getItem('token');
  
    // üõë Si no hay sesi√≥n, redirigir
    if (!token) {
      alert('Debes iniciar sesi√≥n');
      window.location.href = 'login.html';
    }
  
    // üìõ Mostrar nombre desde el token
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('nombreUsuario').textContent = payload.nombre;
  
    // üîì Cerrar sesi√≥n
    function cerrarSesion() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
  
    // üì§ Manejo del formulario de subida
    document.getElementById('formImagen').addEventListener('submit', async (e) => {
      e.preventDefault();
      const titulo = document.getElementById('titulo').value.trim();
      const archivo = document.getElementById('archivoImagen').files[0];
      const estado = document.getElementById('estadoPublicacion');
  
      if (!titulo || !archivo) {
        estado.textContent = 'Complet√° todos los campos.';
        estado.style.color = 'red';
        return;
      }
  
      const formData = new FormData();
      formData.append('titulo', titulo);
      formData.append('imagen', archivo);
  
      try {
        const res = await fetch(`${API}/api/imagenes`, {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + token
          },
          body: formData
        });
  
        const data = await res.json();
  
        if (res.ok) {
          estado.textContent = data.mensaje;
          estado.style.color = 'green';
          document.getElementById('formImagen').reset();
          cargarGaleria(); // üîÅ Actualizar galer√≠a
        } else {
          estado.textContent = data.error || 'Error al subir imagen.';
          estado.style.color = 'red';
        }
      } catch (error) {
        estado.textContent = 'Error de red o servidor.';
        estado.style.color = 'red';
        console.error(error);
      }
    });
  
    // üñºÔ∏è Cargar la galer√≠a de im√°genes
    async function cargarGaleria() {
      try {
        const res = await fetch(`${API}/api/imagenes`, {
          headers: {
            Authorization: 'Bearer ' + token
          }
        });
  
        const imagenes = await res.json();
        const galeria = document.getElementById('galeria');
        galeria.innerHTML = '';
  
        if (!imagenes.length) {
          galeria.innerHTML = '<p>No subiste ninguna imagen a√∫n.</p>';
          return;
        }
  
        imagenes.forEach(img => {
          console.log('üßæ Archivo:', img.archivo);
          const div = document.createElement('div');
          div.className = 'galeria-item';
          const ruta = `${API}/public/imagenes/${encodeURIComponent(img.url)}`;
          console.log('üñºÔ∏è Ruta final:', ruta);
          

          div.innerHTML = `
            <p><strong>${img.titulo}</strong></p>
            <img src="${ruta}" alt="${img.titulo}" style="max-width:100%; border-radius:10px;">
          `;
          galeria.appendChild(div);
        });
      } catch (err) {
        console.error('Error al cargar galer√≠a:', err);
      }
    }
  
    // üîÅ Ejecutar al cargar
    cargarGaleria();
  </script>
  

</body>

</html>